@page "/registro"
@rendermode InteractiveServer
@using centroDeportivo.Aplicacion
@using centroDeportivo.Aplicacion.CasosDeUso
@using centroDeportivo.Aplicacion.Seguridad
@inject AgregarUsuarioUseCase AgregarUsuarioUC
@inject ListarUsuariosUseCase ListarUsuariosUC
@inject NavigationManager Nav
@inject ServicioHash HashService

<PageTitle>Registro - Centro Deportivo</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h3>Crear Cuenta</h3>
                </div>
                <div class="card-body p-4">
                    @if (registroExitoso)
                    {
                        <div class="alert alert-success mt-3 shadow-sm">
                            <i class="bi bi-check-circle-fill"></i> ¡Registro exitoso! 
                            <strong>Redirigiendo al login...</strong>
                        </div>
                    }

                    @* Usamos un formulario estándar de HTML con @onsubmit *@
                    @* Esto evita que el validador automático de Blazor choque con la password hasheada *@
                    <form @onsubmit="Registrar">
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            @* Usamos InputText pero dentro de un formulario manual *@
                            <InputText @bind-Value="nuevoUsuario.Nombre" class="form-control" placeholder="Ej: Juan" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Apellido</label>
                            <InputText @bind-Value="nuevoUsuario.Apellido" class="form-control" placeholder="Ej: Pérez" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Correo Electrónico</label>
                            <InputText @bind-Value="nuevoUsuario.Mail" class="form-control" placeholder="nombre@ejemplo.com" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Contraseña</label>
                            @* Vinculamos a la variable local. Sin oninput para evitar errores de renderizado *@
                            <InputText @bind-Value="passwordPlana" 
                                       type="password" 
                                       class="form-control" 
                                       placeholder="Mínimo 4 caracteres" />
                        </div>

                        @* Mostramos el mensajeError que manejas en el C# *@
                        @if (!string.IsNullOrEmpty(mensajeError))
                        {
                            <div class="alert alert-danger shadow-sm mt-3">
                                <i class="bi bi-exclamation-triangle-fill"></i> @mensajeError
                            </div>
                        }

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success">Confirmar Registro</button>
                            <button type="button" class="btn btn-link" @onclick="Volver">Ya tengo cuenta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private Usuario nuevoUsuario = new Usuario();
    private string? mensajeError;
    private bool registroExitoso = false; // Nueva variable para mostrar el cartel verde
    private string passwordPlana = string.Empty;

    private async Task Registrar()
{
    mensajeError = null; // Limpiar error al empezar

    // 1. VALIDACIÓN MANUAL 
    if (string.IsNullOrWhiteSpace(passwordPlana) || passwordPlana.Length < 4)
    {
        mensajeError = "La contraseña debe tener al menos 4 caracteres.";
        StateHasChanged();
        return; 
    }

    try 
    {
        // 2. Lógica de negocio
        var usuariosExistentes = ListarUsuariosUC.Ejecutar();
        nuevoUsuario.ListaPermisos = (usuariosExistentes.Count == 0) 
            ? Enum.GetValues<Permiso>().ToList() 
            : new List<Permiso>();

        // 3. Hasheo
        nuevoUsuario.Password = HashService.CalcularHash(passwordPlana);
        
        // 4. Guardar
        AgregarUsuarioUC.Ejecutar(nuevoUsuario);
        
        // 5. Éxito
        passwordPlana = "";
        registroExitoso = true;
        StateHasChanged();
        await Task.Delay(2000); 
        Nav.NavigateTo("/login");
    }
    catch (Exception ex)
    {
        mensajeError = "Error: " + ex.Message;
        passwordPlana = "";
    }
}

    private void Volver() => Nav.NavigateTo("/login");
}