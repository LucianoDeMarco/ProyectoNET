@page "/usuarios/gestionar"
@rendermode InteractiveServer
@using centroDeportivo.Aplicacion
@using centroDeportivo.Aplicacion.CasosDeUso
@using centroDeportivo.UI.Servicios
@using centroDeportivo.Aplicacion.Seguridad
@inject ListarUsuariosUseCase ListarUsuariosUC
@inject ModificarUsuarioUseCase ModificarUsuarioUC
@inject SesionService Sesion
@inject NavigationManager Nav

<PageTitle>Directorio de Socios - Centro Deportivo</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-people-fill"></i> Directorio de Socios</h3>
        <button class="btn btn-outline-secondary btn-sm" @onclick='() => Nav.NavigateTo("/dashboard")'>Volver</button>
    </div>
    
    @* Mensaje solo para Admins *@
    @if (esAdmin)
    {
        <div class="alert alert-warning py-2 mb-3">
            <i class="bi bi-shield-lock-fill"></i> 
            <small>Modo Administrador: Puedes restablecer contraseñas.</small>
        </div>
    }

    @if (usuarios == null)
    {
        <div class="d-flex align-items-center">
            <div class="spinner-border text-primary me-2"></div>
            <span>Cargando directorio...</span>
        </div>
    }
    else if (usuarios.Count == 0)
    {
        <div class="alert alert-info">No hay usuarios registrados.</div>
    }
    else
    {
        <table class="table table-hover shadow-sm mt-3">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Email</th>
                    <th>ID Socio</th>
                    
                    @* OJO: La columna "Acciones" solo se dibuja si sos Admin *@
                    @if (esAdmin) 
                    { 
                        <th class="text-center">Acciones</th> 
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var user in usuarios)
                {
                    <tr>
                        <td>@user.Nombre</td>
                        <td>@user.Apellido</td>
                        <td>@user.Mail</td>
                        <td><span class="badge bg-secondary">#@user.Id</span></td>
                        
                        @* Botones: Solo si sos Admin *@
                        @if (esAdmin)
                        {
                           <td class="text-center">
                                @* No te podés resetear a vos mismo *@
                                @if(user.Id != Sesion.UsuarioActual?.Id)
                                {
                                    <button class="btn btn-warning btn-sm" @onclick="() => AbrirModalReset(user)">
                                        <i class="bi bi-key-fill"></i> Resetear
                                    </button>
                                }
                           </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@* --- Modal de Reset (Solo se muestra si sos Admin) --- *@
@if (usuarioAEditar != null && esAdmin)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Nueva clave para @usuarioAEditar.Nombre</h5>
                    <button type="button" class="btn-close" @onclick="() => usuarioAEditar = null"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Contraseña Temporal:</label>
                        <input type="text" class="form-control" @bind="nuevaPass" placeholder="Mínimo 4 caracteres" />
                    </div>
                    @if (errorModal != null)
                    {
                        <div class="text-danger small">@errorModal</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => usuarioAEditar = null">Cancelar</button>
                    <button class="btn btn-primary" @onclick="ProcesarReset">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Usuario>? usuarios;
    private Usuario? usuarioAEditar;
    private string nuevaPass = "";
    private string? errorModal;
    
    // Variable clave para controlar qué se ve
    private bool esAdmin = false; 

    protected override void OnInitialized()
    {
        // 1. Si no hay nadie, al login
        if (!Sesion.EstaLogueado) 
        { 
            Nav.NavigateTo("/login"); 
            return; 
        }

        // 2. SEGURIDAD: Ahora permitimos entrar con "UsuarioLectura"
        // Antes pedíamos "UsuarioModificacion" y por eso rebotaba.
        if (!Sesion.UsuarioActual!.ListaPermisos.Contains(Permiso.UsuarioLectura))
        {
            Nav.NavigateTo("/dashboard");
            return;
        }

        // 3. Chequeamos si tiene "Superpoderes" para activar los botones
        esAdmin = Sesion.UsuarioActual.ListaPermisos.Contains(Permiso.UsuarioModificacion);

        CargarUsuarios();
    }

    private void CargarUsuarios()
    {
        try { usuarios = ListarUsuariosUC.Ejecutar(); }
        catch { usuarios = new List<Usuario>(); }
    }

    private void AbrirModalReset(Usuario u)
    {
        usuarioAEditar = u;
        nuevaPass = "";
        errorModal = null;
    }

    private void ProcesarReset()
    {
        if (string.IsNullOrWhiteSpace(nuevaPass) || nuevaPass.Length < 4)
        {
            errorModal = "La contraseña es muy corta.";
            return;
        }
        
        if (usuarioAEditar != null)
        {
            usuarioAEditar.Password = nuevaPass;
            // IMPORTANTE: El 'true' final indica que hay que hashear la clave
            ModificarUsuarioUC.Ejecutar(Sesion.UsuarioActual!, usuarioAEditar, true);
            usuarioAEditar = null;
        }
    }
}