@page "/usuarios/gestionar"
@rendermode InteractiveServer
@using centroDeportivo.Aplicacion
@using centroDeportivo.Aplicacion.CasosDeUso
@using centroDeportivo.UI.Servicios
@using centroDeportivo.Aplicacion.Seguridad
@inject ListarUsuariosUseCase ListarUsuariosUC
@inject ModificarUsuarioUseCase ModificarUsuarioUC
@inject SesionService Sesion
@inject NavigationManager Nav

<PageTitle>Gestión de Usuarios - Centro Deportivo</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-people-fill"></i> Administración de Usuarios</h3>
        <button class="btn btn-outline-secondary btn-sm" @onclick='() => Nav.NavigateTo("/dashboard")'>Volver</button>
    </div>
    
    <p class="text-muted">Desde aquí puedes restablecer contraseñas tras contacto directo con el usuario.</p>

    @if (usuarios == null)
    {
        <div class="d-flex align-items-center">
            <div class="spinner-border text-primary me-2"></div>
            <span>Cargando usuarios...</span>
        </div>
    }
    else if (usuarios.Count <= 1 && usuarios.Any(u => u.Id == Sesion.UsuarioActual?.Id))
    {
        @* Si solo estás vos (el Admin), mostramos que no hay otros usuarios *@
        <div class="alert alert-info shadow-sm mt-3">
            <i class="bi bi-info-circle-fill"></i> No hay otros usuarios registrados para modificar su contraseña.
        </div>
    }
    else
    {
        <table class="table table-hover shadow-sm mt-3">
            <thead class="table-dark">
                <tr>
                    <th>Nombre Completo</th>
                    <th>Email</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in usuarios)
                {
                    @* Ocultamos al admin logueado de la lista para que no se auto-resetee *@
                    if (user.Id != Sesion.UsuarioActual?.Id)
                    {
                        <tr>
                            <td class="align-middle">@user.Nombre @user.Apellido</td>
                            <td class="align-middle">@user.Mail</td>
                            <td class="text-center">
                                <button class="btn btn-warning btn-sm" @onclick="() => AbrirModalReset(user)">
                                    <i class="bi bi-shield-lock"></i> Resetear Clave
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    }
</div>

@* --- "Modal" sencillo para el cambio de clave --- *@
@if (usuarioAEditar != null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Nueva clave para @usuarioAEditar.Nombre</h5>
                    <button type="button" class="btn-close" @onclick="() => usuarioAEditar = null"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Escribe la nueva contraseña temporal:</label>
                        <input type="password" class="form-control" @bind="nuevaPass" placeholder="Mínimo 4 caracteres" />
                        @if (errorModal != null)
                        {
                            <div class="text-danger mt-2 small">@errorModal</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => usuarioAEditar = null">Cancelar</button>
                    <button class="btn btn-primary" @onclick="ProcesarReset">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Usuario>? usuarios;
    private Usuario? usuarioAEditar;
    private string nuevaPass = "";
    private string? errorModal;

    protected override void OnInitialized()
{
    // 1. Verificación de Seguridad: ¿Hay alguien logueado?
    // Usamos ?. para que si es nulo no explote, y ?? false para que de falso
    if (Sesion.UsuarioActual == null)
    {
        Console.WriteLine("DEBUG: No hay usuario en sesión, redirigiendo...");
        Nav.NavigateTo("/login");
        return;
    }

    // 2. Ahora que sabemos que el usuario NO es nulo, miramos los permisos
    if (!Sesion.UsuarioActual.ListaPermisos.Contains(Permiso.UsuarioModificacion))
    {
        Console.WriteLine("DEBUG: El usuario no tiene el permiso UsuarioModificacion");
        Nav.NavigateTo("/dashboard");
        return;
    }

    // 3. Si pasó los filtros, cargamos la lista
    try 
    {
        usuarios = ListarUsuariosUC.Ejecutar();
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error al cargar usuarios: {ex.Message}");
        usuarios = new List<Usuario>(); 
    }
}

    private void AbrirModalReset(Usuario u)
    {
        usuarioAEditar = u;
        nuevaPass = "";
        errorModal = null;
    }

    private void ProcesarReset()
    {
        if (string.IsNullOrWhiteSpace(nuevaPass) || nuevaPass.Length < 4)
        {
            errorModal = "La contraseña debe tener al menos 4 caracteres.";
            return;
        }

        if (usuarioAEditar != null)
        {
            try 
            {
                usuarioAEditar.Password = nuevaPass;
                // El parámetro 'true' indica que es un Reset y debe hashear la clave
                ModificarUsuarioUC.Ejecutar(Sesion.UsuarioActual!, usuarioAEditar, true);
                
                usuarioAEditar = null;
                nuevaPass = "";
                StateHasChanged();
            }
            catch (Exception ex)
            {
                errorModal = "Error: " + ex.Message;
            }
        }
    }
}